<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>N-Body Playground by Steve Cullen and ChatGPT (v2.8.5-offline-with-presets)</title>
<style>
html, body { margin:0; height:100%; background:#000; color:#fff; font-family:Arial, sans-serif; overflow:hidden; }
#titleBar { position:fixed; top:0; left:0; right:0; background:#111; padding:8px 10px; font-weight:bold; display:flex; gap:10px; align-items:center; }
#status { font-size:12px; color:#0f0; }
#topControls { position:fixed; top:36px; left:8px; display:flex; gap:10px; align-items:center; background:rgba(0,0,0,0.55); padding:6px 8px; border-radius:8px; font-size:12px; }
#topControls input[type="range"]{ width:240px; }
#metrics { position:fixed; right:8px; top:36px; background:rgba(0,0,0,0.55); padding:8px; font-size:12px; white-space:pre; border-radius:8px; }
canvas { display:block; }
#simCanvas { position:fixed; inset:0; }
</style>
</head>
<body>
<div id="titleBar">N-Body Playground by Steve Cullen and ChatGPT (v2.8.5-offline-with-presets) <span id="status">Booting…</span></div>
<div id="topControls">
  <span>Speed (yrs/sec)</span><input id="speed" type="range" min="0.001" max="500" step="0.001" value="0.1"><span id="speedVal">0.10</span>
  <span>Preset</span>
  <select id="preset">
    <option value="cold">Cold Start (still)</option>
    <option value="disk">Thin Disk (circular)</option>
    <option value="thick">Thick Disk (circular)</option>
    <option value="swarm" selected>Isotropic Swarm</option>
    <option value="kepler">Kepler Belt</option>
    <option value="hot">High-Energy Swarm</option>
  </select>
  <button id="applyPreset">Apply</button>
</div>
<div id="metrics">—</div>
<canvas id="simCanvas"></canvas>

<script>
(function(){
  'use strict';
  // Elements
  var statusEl=document.getElementById('status');
  var metricsEl=document.getElementById('metrics');
  var canvas=document.getElementById('simCanvas');
  var speedEl=document.getElementById('speed');
  var speedVal=document.getElementById('speedVal');
  var presetSel=document.getElementById('preset');
  var applyBtn=document.getElementById('applyPreset');

  // WebGL
  var gl = canvas.getContext('webgl', {antialias:false, alpha:false});
  if(!gl){ status('WebGL not supported', true); return; }
  status('WebGL OK — initializing…');

  function status(msg, err){ statusEl.textContent=msg; statusEl.style.color=err?'#f66':'#0f0'; }

  function resize(){
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    gl.viewport(0,0,gl.drawingBufferWidth, gl.drawingBufferHeight);
  }
  window.addEventListener('resize', resize); resize();

  // Math helpers (AU/yr)
  function V3(x,y,z){ return {x:x,y:y,z:z}; }
  function add(a,b){ return V3(a.x+b.x, a.y+b.y, a.z+b.z); }
  function sub(a,b){ return V3(a.x-b.x, a.y-b.y, a.z-b.z); }
  function mul(a,s){ return V3(a.x*s, a.y*s, a.z*s); }
  function len(a){ return Math.sqrt(a.x*a.x + a.y*a.y + a.z*a.z); }
  function norm(a){ var L=len(a)||1; return mul(a,1/L); }
  function randn(){ // Box-Muller
    var u=Math.random(), v=Math.random();
    return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
  }

  // Constants
  var G = 39.478; // AU^3 / (M_sun * yr^2)
  var centralMass = 1.0; // M_sun
  var N = 800;
  var Rinit = 12; // AU
  var bodies=[]; // {p:V3, v:V3, m:number}

  // Presets
  function buildPreset(kind){
    bodies.length=0;
    if(kind==='cold'){
      for(var i=0;i<N;i++){
        var r=Rinit*Math.cbrt(Math.random()); // inside sphere
        var th=Math.random()*2*Math.PI;
        var ph=Math.acos(2*Math.random()-1);
        var p=V3(r*Math.sin(ph)*Math.cos(th), r*Math.sin(ph)*Math.sin(th), r*Math.cos(ph));
        bodies.push({p:p, v:V3(0,0,0), m:1});
      }
    } else if(kind==='disk' || kind==='thick' || kind==='kepler'){
      var thickness = (kind==='disk')? 0.05 : (kind==='kepler'?0.02:0.4);
      for(var j=0;j<N;j++){
        var r= (2 + Math.random()*(Rinit-2));
        var a=Math.random()*2*Math.PI;
        var z=(randn()*thickness*r);
        var p=V3(r*Math.cos(a), r*Math.sin(a), z);
        // circular velocity magnitude
        var vmag = Math.sqrt(G*centralMass/Math.max(r,0.1));
        // direction: tangent in XY plane
        var t=norm(V3(-p.y, p.x, 0));
        var v=mul(t, vmag);
        // small vertical component for thick disk
        if(kind!=='disk'){ v.z += (Math.random()-0.5)*0.05*vmag; }
        bodies.push({p:p, v:v, m:1});
      }
    } else if(kind==='hot'){
      for(var k=0;k<N;k++){
        var r2 = Rinit*Math.cbrt(Math.random());
        var th2=Math.random()*2*Math.PI;
        var ph2=Math.acos(2*Math.random()-1);
        var p2=V3(r2*Math.sin(ph2)*Math.cos(th2), r2*Math.sin(ph2)*Math.sin(th2), r2*Math.cos(ph2));
        var dir=norm(V3(randn(),randn(),randn()));
        var vmag2 = Math.sqrt(G*centralMass/Math.max(r2,0.1))*1.6;
        var v2=mul(dir, vmag2);
        bodies.push({p:p2, v:v2, m:1});
      }
    } else { // swarm
      for(var i2=0;i2<N;i2++){
        var r3=Rinit*Math.cbrt(Math.random());
        var th3=Math.random()*2*Math.PI;
        var ph3=Math.acos(2*Math.random()-1);
        var p3=V3(r3*Math.sin(ph3)*Math.cos(th3), r3*Math.sin(ph3)*Math.sin(th3), r3*Math.cos(ph3));
        // mild tangential bias
        var vmag3 = Math.sqrt(G*centralMass/Math.max(r3,0.1))*0.7;
        var t3=norm(V3(-p3.y, p3.x, 0));
        var v3=add(mul(t3, vmag3), mul(norm(V3(randn(),randn(),randn())), 0.2*vmag3));
        bodies.push({p:p3, v:v3, m:1});
      }
    }
  }

  // Initial build
  buildPreset('swarm');

  // GL program
  function makeProgram(){
    var vs='attribute vec3 pos; uniform float scale; void main(){ gl_Position=vec4(pos*scale,1.0); gl_PointSize=2.5; }';
    var fs='precision mediump float; void main(){ gl_FragColor=vec4(1.0,1.0,1.0,1.0);}';
    function sh(type,src){ var s=gl.createShader(type); gl.shaderSource(s,src); gl.compileShader(s); if(!gl.getShaderParameter(s,gl.COMPILE_STATUS)) throw new Error(gl.getShaderInfoLog(s)); return s; }
    var p=gl.createProgram();
    gl.attachShader(p, sh(gl.VERTEX_SHADER,vs));
    gl.attachShader(p, sh(gl.FRAGMENT_SHADER,fs));
    gl.linkProgram(p);
    if(!gl.getProgramParameter(p, gl.LINK_STATUS)) throw new Error(gl.getProgramInfoLog(p));
    return p;
  }
  var prog=makeProgram();
  var locPos=gl.getAttribLocation(prog,'pos');
  var locScale=gl.getUniformLocation(prog,'scale');
  var buf=gl.createBuffer();

  // Speed + controls
  var SIM_SPEED=0.1;
  function setSpeed(v){ SIM_SPEED=v; speedVal.textContent=(Math.round(v*1000)/1000).toFixed(3); }
  speedEl.addEventListener('input', function(){ setSpeed(parseFloat(speedEl.value)); });
  setSpeed(parseFloat(speedEl.value));

  applyBtn.onclick=function(){
    var kind=presetSel.value;
    buildPreset(kind);
    status('Preset: '+kind+' (N='+N+')');
  };

  // Integrator
  var last=performance.now();
  function step(dtYears){
    // sub-steps for stability
    var hMax=0.01;
    var steps = Math.max(1, Math.ceil(dtYears/hMax));
    var h=dtYears/steps;
    for(var s=0;s<steps;s++){
      for(var i=0;i<bodies.length;i++){
        var p=bodies[i].p, v=bodies[i].v;
        var r=Math.max(len(p), 0.05);
        var aMag = G*centralMass/(r*r);
        var a = mul(norm(mul(p,-1)), aMag);
        // semi-implicit Euler
        bodies[i].v = add(v, mul(a, h));
        bodies[i].p = add(p, mul(bodies[i].v, h));
      }
    }
  }

  // Draw
  function draw(){
    // auto-fit scale
    var rMax=1;
    for(var i=0;i<bodies.length;i++){ var r=len(bodies[i].p); if(r>rMax) rMax=r; }
    var scale = 0.95/(rMax||1);

    var pts=new Float32Array(bodies.length*3);
    for(var k=0;k<bodies.length;k++){ var q=bodies[k].p; pts[3*k]=q.x; pts[3*k+1]=q.y; pts[3*k+2]=q.z; }

    gl.clearColor(0,0,0,1);
    gl.clear(gl.COLOR_BUFFER_BIT);
    gl.useProgram(prog);
    gl.uniform1f(locScale, scale);
    gl.bindBuffer(gl.ARRAY_BUFFER, buf);
    gl.bufferData(gl.ARRAY_BUFFER, pts, gl.DYNAMIC_DRAW);
    gl.enableVertexAttribArray(locPos);
    gl.vertexAttribPointer(locPos,3,gl.FLOAT,false,0,0);
    gl.drawArrays(gl.POINTS, 0, bodies.length);

    metricsEl.textContent = "Version: v2.8.5-offline-with-presets\nBodies: "+bodies.length+"\nCentral mass: "+centralMass.toFixed(2)+" M_sun\nMax radius: "+rMax.toFixed(2)+" AU\nSpeed: "+SIM_SPEED.toFixed(3)+" yrs/sec";
  }

  // Main loop
  function loop(){
    requestAnimationFrame(loop);
    var now=performance.now(); var dt=(now-last)/1000; last=now;
    var dtYears = dt*SIM_SPEED;
    try{
      step(dtYears);
      draw();
      status('Running ✅');
    }catch(e){
      status('Error: '+e.message, true);
    }
  }
  loop();
})();
</script>
</body>
</html>
