<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>N-Body Playground by Steve Cullen and ChatGPT (v2.6.0-offline)</title>
<style>
  html, body { margin:0; height:100%; background:#0b0f16; color:#e6eef8; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; overflow:hidden; }
  #topbar { position:fixed; top:0; left:0; right:0; display:flex; align-items:center; gap:16px; padding:10px 12px; background:#0d1628; border-bottom:1px solid #1a2b4a; z-index:20; }
  #title { font-weight:700; letter-spacing:.3px; }
  #status { font:12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space:pre; opacity:.95; }
  #app { position:fixed; inset:46px 0 0 0; display:grid; grid-template-columns:320px 1fr 360px; }
  #left, #right { background:#0e1320; border-right:1px solid #1a2235; overflow:auto; }
  #right { border-left:1px solid #1a2235; border-right:none; }
  #viewport { position:relative; background:#0b0f16; }
  .panel { padding:12px; }
  h2 { margin:8px 0 6px; font-size:16px; letter-spacing:.3px; color:#b9d2ff }
  .group { margin:8px 0 14px; padding:10px; background:#0b1120; border:1px solid #1a2235; border-radius:8px; }
  .row { display:grid; grid-template-columns: 1fr 110px; gap:8px; align-items:center; margin:6px 0; }
  .row label { font-size:13px; color:#cfe0ff; }
  .row input[type="range"] { width:100%; }
  .row input[type="number"], .row select { width:100%; padding:6px; background:#0f1526; border:1px solid #28365a; color:#e6eef8; border-radius:6px; }
  .buttons { display:flex; gap:8px; flex-wrap:wrap; }
  button { padding:8px 10px; border-radius:8px; border:1px solid #33466f; background:#13203a; color:#e6eef8; cursor:pointer; }
  button.primary { border-color:#4a83ff; background:#1a2f5c; }
  .hint { font-size:12px; color:#9fb4db; margin-top:6px; }
  #chartWrap { position:absolute; left:12px; bottom:12px; width:520px; background:#0d1322c0; border:1px solid #1a2235; border-radius:8px; padding:8px; backdrop-filter: blur(4px); }
  #chart { width:100%; height:140px; display:block; background:#0c111d; border-radius:6px; }
  #legend { display:flex; gap:12px; font-size:12px; margin:6px 2px 0; color:#c9d8f4; opacity:.9; }
  #legend span::before { content:""; display:inline-block; width:10px; height:10px; margin-right:6px; border-radius:2px; vertical-align:baseline; }
  #legK::before { background:#6fc2ff; }
  #legU::before { background:#f6d06f; }
  #legT::before { background:#a9f56f; }
  #metrics { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; line-height:1.35; white-space:pre-wrap; }
  canvas { display:block; }
  #glCanvas { position:absolute; inset:0; }
  #trailCanvas { position:absolute; inset:0; pointer-events:none; }
  #trackballTip { position:absolute; top:10px; right:12px; background:#0d1322d0; border:1px solid #1a2235; padding:6px 8px; border-radius:6px; font-size:12px; }
</style>
</head>
<body>
<div id="topbar">
  <div id="title">N-Body Playground by Steve Cullen and ChatGPT (v2.6.0-offline)</div>
  <div id="status">Bootingâ€¦</div>
</div>

<div id="app">
  <div id="left" class="panel">
    <h2>Setup</h2>
    <div class="group">
      <div class="row"><label>Stars (N)</label><input id="nStars" type="range" min="50" max="2500" step="50" value="900"><input id="nStarsNum" type="number" min="50" max="2500" step="50" value="900"></div>
      <div class="row"><label>Init radius (AU)</label><input id="radiusAU" type="range" min="0.2" max="50" step="0.1" value="6"><input id="radiusAUNum" type="number" min="0.2" max="50" step="0.1" value="6"></div>
      <div class="row"><label>Init velocity (km/s)</label><input id="initV" type="range" min="0" max="120" step="1" value="10"><input id="initVNum" type="number" min="0" max="120" step="1" value="10"></div>
      <div class="row"><label>Star mass min (Mâ˜‰)</label><input id="mMin" type="range" min="1e-6" max="1" step="1e-6" value="5e-5"><input id="mMinNum" type="number" step="1e-6" value="5e-5"></div>
      <div class="row"><label>Star mass max (Mâ˜‰)</label><input id="mMax" type="range" min="1e-6" max="5" step="1e-6" value="1e-3"><input id="mMaxNum" type="number" step="1e-6" value="1e-3"></div>
      <div class="row"><label>Time scale (Ã—)</label><input id="timeScale" type="range" min="100" max="5000" step="50" value="1500"><input id="timeScaleNum" type="number" min="100" max="5000" step="50" value="1500"></div>
    </div>

    <h2>Central Star</h2>
    <div class="group">
      <div class="row"><label>Mass (Mâ˜‰)</label><input id="mCentral" type="range" min="0.1" max="50" step="0.1" value="1"><input id="mCentralNum" type="number" min="0.1" max="50" step="0.1" value="1"></div>
      <div class="row"><label>Glow</label>
        <select id="glowMode">
          <option value="off">Off</option>
          <option value="on" selected>On</option>
        </select>
        <input id="glowIntensity" type="range" min="0" max="1" step="0.01" value="0.65">
      </div>
    </div>

    <h2>Collisions</h2>
    <div class="group">
      <div class="row"><label>Collision mode</label>
        <select id="collisionMode">
          <option value="none" selected>None</option>
          <option value="elastic">Elastic</option>
          <option value="merge">Merge</option>
        </select>
      </div>
      <div class="row"><label>Softening (Îµ AU)</label><input id="softening" type="range" min="0" max="0.2" step="0.001" value="0.01"><input id="softeningNum" type="number" min="0" max="0.2" step="0.001" value="0.01"></div>
    </div>

    <h2>Trails</h2>
    <div class="group">
      <div class="row"><label>Preset</label>
        <select id="trailPreset">
          <option value="none">None</option>
          <option value="short">Short</option>
          <option value="long" selected>Long</option>
          <option value="ultra">Ultra</option>
        </select>
      </div>
      <div class="row"><label>Persistence (s)</label><input id="trailSeconds" type="range" min="0" max="90" step="1" value="24"><input id="trailSecondsNum" type="number" min="0" max="90" step="1" value="24"></div>
    </div>

    <div class="buttons">
      <button id="btnReset">Reset</button>
      <button id="btnStart" class="primary">Start</button>
      <button id="btnPause">Pause</button>
      <button id="btnClear">Clear Trails</button>
      <button id="btnAutoFit">Auto Fit</button>
    </div>

    <div class="hint">Trackball: rotate (Left drag) â€¢ pan (Right/Middle drag or Shift+Left) â€¢ zoom (wheel).</div>
  </div>

  <div id="viewport">
    <canvas id="glCanvas"></canvas>
    <canvas id="trailCanvas"></canvas>
    <div id="trackballTip">ðŸ–± Trackball ready</div>
    <div id="chartWrap">
      <canvas id="chart"></canvas>
      <div id="legend"><span id="legK">Kinetic</span><span id="legU">Potential</span><span id="legT">Total</span></div>
    </div>
  </div>

  <div id="right" class="panel">
    <h2>Metrics</h2>
    <div class="group"><div id="metrics">â€”</div></div>
  </div>
</div>

<script>
(function(){
  'use strict';
  // --- Error reporter
  function reportError(err){
    const statusEl = document.getElementById('status');
    statusEl.textContent = 'âŒ Error: ' + (err && err.message ? err.message : err);
    statusEl.style.color = '#ff8383';
    console.error(err);
  }
  try{
    const statusEl = document.getElementById('status');
    function setStatus(t,err){ statusEl.textContent=t; statusEl.style.color=err?'#ff7b7b':''; }

    // --- Globals declared up-front to avoid TDZ
    var gl, tctx, chartCtx;
    var chartData = []; var chartMax = 600;
    var AU = 1.496e11, MSUN = 1.989e30, G = 6.67430e-11;
    var N = 0, pos, vel, size, col, mass;
    var state = null, centralMass = 1*MSUN;
    var sphR=18, sphPhi=Math.PI/2.2, sphTheta=0.9, target = v3(0,0,0);
    var lastTime = 0;

    // --- Element handles
    var glCanvas = document.getElementById('glCanvas');
    var trailCanvas = document.getElementById('trailCanvas');
    var chartCanvas = document.getElementById('chart');
    var metricsEl = document.getElementById('metrics');

    // --- Boot WebGL
    gl = glCanvas.getContext('webgl', { antialias:true, alpha:false });
    if(!gl){ setStatus('âŒ WebGL not supported by your browser/device', true); return; }
    setStatus('âœ… WebGL OK â€” initializingâ€¦');
    tctx = trailCanvas.getContext('2d');
    chartCtx = chartCanvas.getContext('2d');

    // --- Controls -> state
    function $(id){ return document.getElementById(id); }
    state = {
      n: parseInt($('nStars').value,10),
      radiusAU: parseFloat($('radiusAU').value),
      initV_kms: parseFloat($('initV').value),
      mMinMSun: parseFloat($('mMin').value),
      mMaxMSun: parseFloat($('mMax').value),
      softAU: parseFloat($('softening').value),
      collisionMode: $('collisionMode').value,
      trailSeconds: parseFloat($('trailSeconds').value),
      glow: $('glowMode').value==='on',
      glowIntensity: parseFloat($('glowIntensity').value),
      running:true, timeScale: parseFloat($('timeScale').value), subDt:0.02
    };
    centralMass = parseFloat($('mCentral').value)*MSUN;

    link('nStars','nStarsNum', v=>{ state.n=v|0; resetSystem(); });
    link('radiusAU','radiusAUNum', v=>{ state.radiusAU=v; resetSystem(); });
    link('initV','initVNum', v=>{ state.initV_kms=v; resetSystem(); });
    link('mMin','mMinNum', v=>{ state.mMinMSun=v; resetSystem(); });
    link('mMax','mMaxNum', v=>{ state.mMaxMSun=v; resetSystem(); });
    link('softening','softeningNum', v=>{ state.softAU=v; });
    link('timeScale','timeScaleNum', v=>{ state.timeScale=v; });
    $('collisionMode').addEventListener('change', e=>state.collisionMode=e.target.value);
    $('trailPreset').addEventListener('change', e=>{ var map={none:0,short:6,long:24,ultra:60}; var v=map[e.target.value]; $('trailSeconds').value=v; $('trailSecondsNum').value=v; state.trailSeconds=v; });
    $('glowMode').addEventListener('change', e=>{ state.glow = e.target.value==='on'; });
    $('glowIntensity').addEventListener('input', e=>{ state.glowIntensity=parseFloat(e.target.value); });
    link('mCentral','mCentralNum', v=>{ centralMass=v*MSUN; resetSystem(); });
    $('btnStart').onclick=()=>state.running=true;
    $('btnPause').onclick=()=>state.running=false;
    $('btnReset').onclick=()=>resetSystem();
    $('btnAutoFit').onclick=()=>autoFit();
    $('btnClear').onclick=()=>{ tctx.clearRect(0,0,trailCanvas.width, trailCanvas.height); };

    // --- Resize
    function resizeAll(){
      var vp = document.getElementById('viewport');
      var w = vp.clientWidth||1, h=vp.clientHeight||1;
      gl.canvas.width=w; gl.canvas.height=h; gl.viewport(0,0,w,h);
      trailCanvas.width=w; trailCanvas.height=h;
      var dpr = Math.min(window.devicePixelRatio||1, 2);
      var chartW=520, chartH=140; chartCanvas.width=chartW*dpr; chartCanvas.height=chartH*dpr; chartCanvas.style.width=chartW+'px'; chartCanvas.style.height=chartH+'px';
    } window.addEventListener('resize', resizeAll); resizeAll();

    // --- GL helpers
    function compile(src, type){ var s=gl.createShader(type); gl.shaderSource(s,src); gl.compileShader(s); if(!gl.getShaderParameter(s,gl.COMPILE_STATUS)) throw new Error(gl.getShaderInfoLog(s)); return s; }
    function program(vsSrc, fsSrc){ var p=gl.createProgram(); gl.attachShader(p,compile(vsSrc,gl.VERTEX_SHADER)); gl.attachShader(p,compile(fsSrc,gl.FRAGMENT_SHADER)); gl.linkProgram(p); if(!gl.getProgramParameter(p,gl.LINK_STATUS)) throw new Error(gl.getProgramInfoLog(p)); return p; }

    var vs = [
      'attribute vec3 aPos; attribute float aSize; attribute vec3 aColor;',
      'uniform mat4 uProj, uView; varying vec3 vColor;',
      'void main(){',
      '  vColor = aColor;',
      '  gl_Position = uProj * uView * vec4(aPos,1.0);',
      '  gl_PointSize = aSize / max(gl_Position.w, 0.0001);',
      '}'
    ].join('\n');
    var fs = [
      'precision mediump float; varying vec3 vColor;',
      'uniform float uGlow;',
      'void main(){',
      '  vec2 p = gl_PointCoord*2.0-1.0;',
      '  float r = dot(p,p);',
      '  if(r>1.0) discard;',
      '  float core = smoothstep(1.0, 0.5, 1.0 - r);',
      '  float glow = exp(-r*3.0) * uGlow;',
      '  gl_FragColor = vec4(vColor*(0.6+glow), core*(0.85+0.15*uGlow));',
      '}'
    ].join('\n');
    var prog = program(vs,fs); gl.useProgram(prog);
    var loc = {
      aPos: gl.getAttribLocation(prog,'aPos'),
      aSize: gl.getAttribLocation(prog,'aSize'),
      aColor: gl.getAttribLocation(prog,'aColor'),
      uProj: gl.getUniformLocation(prog,'uProj'),
      uView: gl.getUniformLocation(prog,'uView'),
      uGlow: gl.getUniformLocation(prog,'uGlow')
    };

    // --- Minimal math + trackball
    function v3(x,y,z){ return new Float32Array([x,y,z]); }
    function add(a,b){ return v3(a[0]+b[0],a[1]+b[1],a[2]+b[2]); }
    function sub(a,b){ return v3(a[0]-b[0],a[1]-b[1],a[2]-b[2]); }
    function dot(a,b){ return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]; }
    function cross(a,b){ return v3(a[1]*b[2]-a[2]*b[1], a[2]*b[0]-a[0]*b[2], a[0]*b[1]-a[1]*b[0]); }
    function len(a){ return Math.hypot(a[0],a[1],a[2]); }
    function norm(a){ var l=len(a)||1; return v3(a[0]/l,a[1]/l,a[2]/l); }
    function mat4(){ return new Float32Array(16); }
    function perspective(fovy, aspect, near, far){ var f=1/Math.tan(fovy/2), nf=1/(near-far); var m=mat4();
      m[0]=f/aspect; m[5]=f; m[10]=(far+near)*nf; m[11]=-1; m[14]=(2*far*near)*nf; m[15]=0; return m; }
    function lookAt(eye, tgt, up){
      var z = norm(sub(eye,tgt));
      var x = norm(cross(up,z));
      var y = cross(z,x);
      var m = mat4();
      m[0]=x[0]; m[1]=y[0]; m[2]=z[0]; m[3]=0;
      m[4]=x[1]; m[5]=y[1]; m[6]=z[1]; m[7]=0;
      m[8]=x[2]; m[9]=y[2]; m[10]=z[2]; m[11]=0;
      m[12]=-dot(x,eye); m[13]=-dot(y,eye); m[14]=-dot(z,eye); m[15]=1;
      return m;
    }
    function camPos(){ return v3(
      target[0] + sphR*Math.sin(sphTheta)*Math.sin(sphPhi),
      target[1] + sphR*Math.cos(sphPhi),
      target[2] + sphR*Math.cos(sphTheta)*Math.sin(sphPhi)
    );}
    glCanvas.addEventListener('contextmenu', e=>e.preventDefault());
    var mouseMode='none', sx=0, sy=0;
    glCanvas.addEventListener('mousedown', function(e){ sx=e.clientX; sy=e.clientY; var panBtn = (e.button===1||e.button===2)||e.shiftKey; mouseMode = panBtn ? 'pan' : 'rot'; });
    window.addEventListener('mouseup', function(){ mouseMode='none'; });
    window.addEventListener('mousemove', function(e){
      if(mouseMode==='none') return;
      var dx=e.clientX-sx, dy=e.clientY-sy; sx=e.clientX; sy=e.clientY;
      if(mouseMode==='rot'){ sphTheta -= dx*0.005; sphPhi += dy*0.005; sphPhi=Math.max(0.001,Math.min(Math.PI-0.001,sphPhi)); }
      else if(mouseMode==='pan'){ var r=sphR; target[0] += (-dx*0.002*r); target[1] += (dy*0.002*r); }
    });
    glCanvas.addEventListener('wheel', function(e){ e.preventDefault(); var f=Math.exp((e.deltaY>0?1:-1)*0.1); sphR = Math.max(2, sphR*f); }, {passive:false});

    // --- Buffers
    var bPos = gl.createBuffer(), bSize = gl.createBuffer(), bCol = gl.createBuffer();

    // --- Helpers
    function colorFromMass(mSun){
      var t = Math.max(0, Math.min(1, (Math.log10(mSun+1e-6)+6)/6 ));
      return [1.0, (0.7+0.25*t), (0.5+0.5*(1-t))];
    }
    function starRadiusAU_fromMass(mkg){ var RSun=6.9634e8; var r=RSun*Math.pow(mkg/MSUN,0.8); return (r/AU)*12; }
    function centralRadiusAU(mkg){ var RSun=6.9634e8; var r=RSun*Math.pow(mkg/MSUN,0.8); return (r/AU)*20; }

    function link(rangeId, numId, cb){
      var r=$(rangeId), n=$(numId);
      function sync(fromRange){ if(fromRange) n.value=r.value; else r.value=n.value; cb(parseFloat(r.value)); }
      r.addEventListener('input', function(){ sync(true); });
      n.addEventListener('input', function(){ sync(false); });
      sync(true);
    }

    function upload(){
      gl.bindBuffer(gl.ARRAY_BUFFER, bPos); gl.bufferData(gl.ARRAY_BUFFER, pos, gl.DYNAMIC_DRAW); gl.enableVertexAttribArray(loc.aPos); gl.vertexAttribPointer(loc.aPos,3,gl.FLOAT,false,0,0);
      gl.bindBuffer(gl.ARRAY_BUFFER, bSize); gl.bufferData(gl.ARRAY_BUFFER, size, gl.DYNAMIC_DRAW); gl.enableVertexAttribArray(loc.aSize); gl.vertexAttribPointer(loc.aSize,1,gl.FLOAT,false,0,0);
      gl.bindBuffer(gl.ARRAY_BUFFER, bCol); gl.bufferData(gl.ARRAY_BUFFER, col, gl.DYNAMIC_DRAW); gl.enableVertexAttribArray(loc.aColor); gl.vertexAttribPointer(loc.aColor,3,gl.FLOAT,false,0,0);
    }

    function autoFit(){ sphR = Math.max(8, state.radiusAU*3); sphPhi = Math.PI/2.4; sphTheta = 0.9; target=v3(0,0,0); }

    // --- System init
    function resetSystem(){
      N = state.n;
      pos = new Float32Array((N+1)*3);
      vel = new Float32Array((N+1)*3); // AU/s
      size= new Float32Array(N+1);
      col = new Float32Array((N+1)*3);
      mass= new Float32Array(N+1);
      // central
      pos[0]=0; pos[1]=0; pos[2]=0;
      size[0]=Math.max(6, Math.min(140, centralRadiusAU(centralMass)*160));
      col[0]=1.0; col[1]=0.82; col[2]=0.48;
      mass[0]=centralMass;
      // stars
      var R = state.radiusAU;
      for(var i=1;i<=N;i++){
        var x,y,z; do{ x=(Math.random()*2-1)*R; y=(Math.random()*2-1)*R; z=(Math.random()*2-1)*R; } while(x*x+y*y+z*z>R*R);
        var j=i*3; pos[j]=x; pos[j+1]=y; pos[j+2]=z;
        var m = (state.mMinMSun + Math.random()*(state.mMaxMSun-state.mMinMSun)) * MSUN; mass[i]=m;
        var rAU = Math.max(starRadiusAU_fromMass(m), 0.002);
        size[i]= Math.max(2, rAU*100);
        var c = colorFromMass(m/MSUN); col[3*i]=c[0]; col[3*i+1]=c[1]; col[3*i+2]=c[2];
        var v0_AUps = (state.initV_kms*1000)/AU; // AU/s
        if(v0_AUps!==0){
          var L = Math.hypot(x,y,z)||1; var ax=y/L, ay=-x/L, az=0;
          vel[j]=ax*v0_AUps; vel[j+1]=ay*v0_AUps; vel[j+2]=az*v0_AUps;
        }
      }
      upload();
      chartData.length=0;
      tctx.clearRect(0,0,trailCanvas.width, trailCanvas.height);
      autoFit();
      render();
      setStatus('âœ… Initialized â€” drag to explore, use sliders to tweak');
    }

    // --- Physics
    function stepPhysics(h){
      var eps2 = (state.softAU)*(state.softAU);
      var GM_AU = (G*centralMass)/(AU*AU*AU); // AU^3 / s^2
      for(var i=1;i<=N;i++){
        var j=i*3;
        var x=pos[j], y=pos[j+1], z=pos[j+2];
        var r2=x*x+y*y+z*z+eps2; var r=Math.sqrt(r2)||1;
        var ax = -GM_AU * x / (r*r*r);
        var ay = -GM_AU * y / (r*r*r);
        var az = -GM_AU * z / (r*r*r);
        vel[j]   += ax*h;
        vel[j+1] += ay*h;
        vel[j+2] += az*h;
        pos[j]   += vel[j]*h;
        pos[j+1] += vel[j+1]*h;
        pos[j+2] += vel[j+2]*h;
        var cR = centralRadiusAU(centralMass);
        if(r < cR){
          var nx=x/r, ny=y/r, nz=z/r;
          var vn = vel[j]*nx + vel[j+1]*ny + vel[j+2]*nz;
          vel[j]   -= 2*vn*nx; vel[j+1]-=2*vn*ny; vel[j+2]-=2*vn*nz;
          pos[j]=nx*(cR*1.01); pos[j+1]=ny*(cR*1.01); pos[j+2]=nz*(cR*1.01);
        }
      }
      if(state.collisionMode!=='none'){
        for(var i2=1;i2<=N;i2++) for(var k=i2+1;k<=N;k++){
          var ia=i2*3, ka=k*3;
          var dx=pos[ia]-pos[ka], dy=pos[ia+1]-pos[ka+1], dz=pos[ia+2]-pos[ka+2];
          var d = Math.hypot(dx,dy,dz); var Ri=size[i2]/120, Rk=size[k]/120;
          if(d < (Ri+Rk)){
            if(state.collisionMode==='elastic'){
              var nx2=dx/(d||1), ny2=dy/(d||1), nz2=dz/(d||1);
              var va = vel[ia]*nx2+vel[ia+1]*ny2+vel[ia+2]*nz2;
              var vb = vel[ka]*nx2+vel[ka+1]*ny2+vel[ka+2]*nz2;
              var ma=mass[i2], mb=mass[k];
              var va2=(va*(ma-mb)+2*mb*vb)/(ma+mb);
              var vb2=(vb*(mb-ma)+2*ma*va)/(ma+mb);
              var dva=va2-va, dvb=vb2-vb;
              vel[ia]+=dva*nx2; vel[ia+1]+=dva*ny2; vel[ia+2]+=dva*nz2;
              vel[ka]+=dvb*nx2; vel[ka+1]+=dvb*ny2; vel[ka+2]+=dvb*nz2;
            } else if(state.collisionMode==='merge'){
              var ma2=mass[i2], mb2=mass[k]; var mTot=ma2+mb2;
              var vax=vel[ia], vay=vel[ia+1], vaz=vel[ia+2];
              var vbx=vel[ka], vby=vel[ka+1], vbz=vel[ka+2];
              vel[ia]=(vax*ma2+vbx*mb2)/mTot; vel[ia+1]=(vay*ma2+vby*mb2)/mTot; vel[ia+2]=(vaz*ma2+vbz*mb2)/mTot;
              mass[i2]=mTot; pos[ka]=pos[ka+1]=pos[ka+2]=1e9;
            }
          }
        }
      }
    }

    // --- Energy chart
    function sampleEnergy(){
      var K=0, U=0;
      for(var i=1;i<=N;i++){
        var j=i*3; var vx=vel[j], vy=vel[j+1], vz=vel[j+2]; var m=mass[i];
        K += 0.5*m*(vx*vx+vy*vy+vz*vz)*(AU*AU);
        var r = Math.hypot(pos[j],pos[j+1],pos[j+2])*AU;
        U += -G*centralMass*m/Math.max(r,1);
      }
      chartData.push([K,U,K+U]); if(chartData.length>chartMax) chartData.shift();
    }
    function drawChart(){
      var dpr=Math.min(window.devicePixelRatio||1,2), w=chartCanvas.width, h=chartCanvas.height;
      chartCtx.clearRect(0,0,w,h); if(chartData.length<2) return;
      var K=chartData.map(d=>d[0]), U=chartData.map(d=>d[1]), T=chartData.map(d=>d[2]);
      var minY=Math.min(...K,...U,...T), maxY=Math.max(...K,...U,...T);
      var pad=10*dpr; var xs=(w-2*pad)/(chartData.length-1);
      function mapY(v){ return h - pad - (v-minY)/(maxY-minY+1e-9)*(h-2*pad); }
      function series(arr, col){ chartCtx.beginPath(); chartCtx.lineWidth=2*dpr; chartCtx.strokeStyle=col; chartCtx.moveTo(pad,mapY(arr[0])); for(var i=1;i<arr.length;i++) chartCtx.lineTo(pad+i*xs,mapY(arr[i])); chartCtx.stroke(); }
      series(K,'#6fc2ff'); series(U,'#f6d06f'); series(T,'#a9f56f');
    }

    // --- Trails
    function renderTrails(dt){
      var w=trailCanvas.width, h=trailCanvas.height;
      if(state.trailSeconds<=0){ tctx.clearRect(0,0,w,h); return; }
      var decay=Math.max(0,1 - dt*(1/state.trailSeconds));
      tctx.globalCompositeOperation='source-over'; tctx.fillStyle='rgba(13,19,34,'+(1-decay)+')'; tctx.fillRect(0,0,w,h);
      tctx.globalCompositeOperation='lighter';
      var proj = perspective(Math.PI/3, gl.canvas.width/gl.canvas.height, 0.01, 5000.0);
      var eye = camPos(); var view = lookAt(eye, v3(0,0,0), v3(0,1,0));
      function project(x,y,z){
        var vx = view[0]*x + view[4]*y + view[8]*z + view[12];
        var vy = view[1]*x + view[5]*y + view[9]*z + view[13];
        var vz = view[2]*x + view[6]*y + view[10]*z + view[14];
        var vw = view[3]*x + view[7]*y + view[11]*z + view[15];
        var px = proj[0]*vx + proj[4]*vy + proj[8]*vz + proj[12]*vw;
        var py = proj[1]*vx + proj[5]*vy + proj[9]*vz + proj[13]*vw;
        var pw = proj[3]*vx + proj[7]*vy + proj[11]*vz + proj[15]*vw;
        return [ (px/pw*0.5+0.5)*w, (-py/pw*0.5+0.5)*h ];
      }
      for(var i=1;i<=N;i++){ var j=i*3; var p=project(pos[j],pos[j+1],pos[j+2]); tctx.fillStyle='rgba(180,200,255,'+(0.25+0.6*state.glowIntensity)+')'; tctx.fillRect(p[0],p[1],1.5,1.5); }
    }

    // --- Metrics
    function updateMetrics(){
      var sumR=0,sumV=0; for(var i=1;i<=N;i++){ var j=i*3; sumR+=Math.hypot(pos[j],pos[j+1],pos[j+2]); sumV+=Math.hypot(vel[j],vel[j+1],vel[j+2])*(AU/1000); }
      metricsEl.textContent = [
        'Version: v2.6.0-offline',
        'WebGL: OK',
        'Bodies: '+N,
        'Central Mass: '+(centralMass/MSUN).toFixed(3)+' M\u2609',
        'Avg radius: '+(sumR/Math.max(1,N)).toFixed(3)+' AU',
        'Avg speed: '+(sumV/Math.max(1,N)).toFixed(3)+' km/s',
        'Collision: '+state.collisionMode,
        'Softening Îµ: '+state.softAU.toFixed(3)+' AU',
        'Glow: '+(state.glow?('On ('+state.glowIntensity.toFixed(2)+')'):'Off')
      ].join('\n');
    }

    // --- Render
    function render(){
      var proj = perspective(Math.PI/3, gl.canvas.width/gl.canvas.height, 0.01, 5000.0);
      var eye = camPos(); var view = lookAt(eye, v3(0,0,0), v3(0,1,0));
      gl.useProgram(prog);
      gl.uniformMatrix4fv(loc.uProj,false,proj);
      gl.uniformMatrix4fv(loc.uView,false,view);
      gl.uniform1f(loc.uGlow, state.glow? state.glowIntensity: 0.0);
      gl.enable(gl.BLEND); gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
      gl.enable(gl.DEPTH_TEST); gl.depthFunc(gl.LEQUAL);
      gl.clearColor(0.043,0.059,0.086,1); gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
      upload();
      gl.drawArrays(gl.POINTS, 0, N+1);
    }

    // --- Animate
    function animate(){
      try{
        requestAnimationFrame(animate);
        var now=performance.now(); var dt=Math.max(0,(now-lastTime)/1000); lastTime=now;
        if(state.running){
          var sim = dt*state.timeScale; var steps=Math.max(1, Math.ceil(sim/state.subDt)); var h=sim/steps;
          for(var s=0;s<steps;s++) stepPhysics(h);
          sampleEnergy();
        }
        render(); renderTrails(dt); drawChart(); updateMetrics();
        setStatus('âœ… Running â€” drag to rotate / Shift+drag to pan / wheel to zoom');
      }catch(loopErr){ reportError(loopErr); }
    }

    // --- Kickoff
    resetSystem();
    animate();
  }catch(e){ reportError(e); }
})();
</script>
</body>
</html>
